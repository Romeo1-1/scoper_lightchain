---
title: 'Scoper'
author: "Nima Nouri, Jason Vander Heiden, and Edel Aron"
date: '`r Sys.Date()`'
output:
  pdf_document:
    dev: pdf
    fig_height: 4
    fig_width: 7.5
    highlight: pygments
    toc: yes
  html_document:
    fig_height: 4
    fig_width: 7.5
    highlight: pygments
    theme: readable
    toc: yes
geometry: margin=1in
fontsize: 11pt
vignette: |
  %\VignetteEngine{knitr::rmarkdown}  %\VignetteIndexEntry{Identifying clones from high-throughput B cell repertoire sequencing data}  %\usepackage[utf8]{inputenc}
---

## Description

`scoper` provides a computational framework for identification of B cell clones from 
Adaptive Immune Receptor Repertoire sequencing (AIRR-Seq) data using spectral 
clustering with an adaptive threshold. Three main functions 
are included (`identicalClones`, `hierarchicalClones`, and `spectralClones`) 
that perform clustering among sequences of BCRs/IGs (B cell receptors/immunoglobulins) 
which share the same V gene, J gene and junction length.

## Clonal assignment using an adaptive threshold

A key step in the analysis of Adaptive Immune Receptor Repertoire sequencing (AIRR-Seq) data is
partition data into clonally related lineages. Each lineage is a group of sequences that descendants of a common ancestor cell.

Clonal relationships can be inferred from sequencing data. Hierarchical clustering is a widely used distance-based method for identify clonally related sequences. Usually there is an initial
step, grouping sequences sharing the same V gene, J gene, and junction length. Then, for each group, the high diversity in the junction region is used as a fingerprint to identify clonally related sequences. This method requires a measure of distance between pairs of junction sequences and a choice of linkage to define the distance between groups of sequences. Then, analyzing the distance-to-nearest distribution in the whole dataset, a threshold to cut the hierarchy into discrete clonal groups is selected. Typically, the distribution is bimodal, and the threshold separates the two modes. The first mode represents sequences that have at least one clonal relative in the dataset, and the second mode sequences that do not have any clonal relatives in the data. 

The traditional hierarchical clustering method is available with the function `hierarchicalClones`. But **SCOPer** provides a method with higher sensitivity and specificity compared to the traditional threshold detection. `spectralClones` utilizes spectral clustering with an *adaptive threshold* to determine the local sequence neighborhood. The method is optimized for sensitivity and specificity for the particular data under analysis, and has the additional benefit of being able to choose optimal thresholds where traditional methods fail because the distance-to-nearest distribution is not bimodal.

To learn more about the hierachical clustering  method as implemented in the Immcantation framework, in the [shazam](https://shazam.readthedocs.io) R package, see `?shazam::distToNearest`, `?shazam::findThreshold` and the vignette `DistToNearest`.

## Examples

### Example data

A small example database is included in the `scoper` package. See ` ?scoper::ExampleDb` for details.

```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Load scoper
library("scoper")
```

### Clonal assignment using the spectral model

While hierarchical clustering-based models group sequences using a fixed distance supervised threshold, the spectral clustering-based model uses an adaptive unsupervised threshold to tune the required level of similarity among sequences in different local neighborhoods. 

The function `spectralClones` groups sequences into groups of sequences sharing the same V gene, J gene, and junction length. Then, for each group, it assigns sequences into clonal groups based on junction sequence similarity (`method='novj'`) and additionally, shared mutations patterns in V and J segments (`method='vj'`).


```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Clonal assignment using the spectral model
# IMGT_V object from shazam package to identify sequence limit length
library("shazam")
results <- spectralClones(db = ExampleDb, method = "vj",
                          len_limit = shazam::IMGT_V,
                          sequence = "sequence_alignment",
                          germline = "germline_alignment_d_mask",
                          junction = "junction",
                          v_call = "v_call", j_call = "j_call",
                          max_n = NULL, log = NULL,
                          threshold = 0.15, summarize_clones = TRUE)
# results is an object of class ScoperClones
class(results)
# cloned data (a data.frame), with the column `clone_id`
cloned_db <- results@db
colnames(cloned_db)
# print effective threshold (a numeric)
results@eff_threshold
# get inter and intra clonal distances (a data.frame)
df <- results@inter_intra
head(df)
# plot a histogram of inter versus intra clonal distances (a ggplot).
plot(results, binwidth=0.02)
```

### Clonal assignment using the hierarchical model

The function `hierarchicalClones` performs hierarchical clustering based on the junction sequence similarity among sequences that share the same V gene, J gene, and junction length.


```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Clonal assignment using the hierarchical model
results <- hierarchicalClones(db = ExampleDb, threshold = 0.15,
                              method = "nt",
                              linkage = "single",
                              junction = "junction", v_call = "v_call", j_call = "j_call",
                              max_n = NULL, log = NULL,
                              summarize_clones = TRUE)

# results is an object of class ScoperClones
class(results)
# cloned data (a data.frame)
cloned_db <- results@db
# print effective threshold (a numeric)
results@eff_threshold
# get inter and intra conal distances (a data.frame)
df <- results@inter_intra
# plot a histogram of inter versus intra clonal distances  (a ggplot).
plot(results, binwidth=0.02)
```

### Clonal assignment using identical clones

The function `identicalClones` performs hierarchical clustering among sequences that share the same V gene, J gene and identical junction.


```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Clonal assignment using the hierarchical model
results <- identicalClones(db = ExampleDb,
                              method = "nt",
                              junction = "junction", v_call = "v_call", j_call = "j_call",
                              summarize_clones = TRUE)

# results is an object of class ScoperClones
class(results)
# cloned data (a data.frame)
cloned_db <- results@db
# print effective threshold (a numeric)
results@eff_threshold
# get inter and intra conal distances (a data.frame)
df <- results@inter_intra
# plot a histogram of inter versus intra clonal distances  (a ggplot).
plot(results, binwidth=0.02)
```

